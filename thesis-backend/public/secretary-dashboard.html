<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Γραμματείας</title>
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    /* extra styling for details panel */
    .details-box {
      margin-top: 24px;
      padding: 20px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    .committee-list { margin: 8px 0 0; padding-left: 20px; }
    .committee-list li { margin: 2px 0; }
    .sd-btn-small {
      display:inline-block; padding:6px 12px; font-size:0.85rem;
      margin:0 4px; border-radius:6px; background: var(--primary);
      color:white; text-decoration:none; transition:background .15s;
    }
    .sd-btn-small:hover { background: var(--primary-hover); }

    .box-row {
      margin-top: 15px; padding: 12px; border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .box-row input, .box-row textarea {
      padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;
      margin-right: 8px; width: 100%; max-width: 420px;
      background: rgba(0,0,0,0.25); color: #fff;
    }
    .box-row textarea { min-height: 80px; resize: vertical; }
    .row-actions { margin-top: 8px; }
  </style>
</head>
<body class="secretary-dashboard">
  <header class="sd-header">
    <h1>Dashboard Γραμματείας</h1>
    <button class="sd-logout" onclick="logout()">Αποσύνδεση</button>
  </header>

  <main class="sd-main">
    <h2>Διπλωματικές (ACTIVE / UNDER-EXAMINATION)</h2>

    <div class="sd-card">
      <table class="sd-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Τίτλος</th>
            <th>Καθηγητής</th>
            <th>Κατάσταση</th>
            <th>Έναρξη</th>
            <th>Ενέργειες</th>
          </tr>
        </thead>
        <tbody id="thesesBody"></tbody>
      </table>
    </div>

    <!-- Λεπτομέρειες -->
  <div id="detailsBox" class="details-box" style="display:none;">
      <h3 id="detTitle"></h3>
      <p><strong>Περιγραφή:</strong> <span id="detDesc"></span></p>
      <p><strong>Κατάσταση:</strong> <span id="detStatus"></span></p>
      <p><strong>Μέλη Επιτροπής:</strong></p>
      <ul id="committeeList" class="committee-list"></ul>
      <p><strong>Χρόνος από Ανάθεση:</strong> <span id="detElapsed"></span></p>

      <!-- ✅ Καταχώρηση ΑΠ (μόνο για ACTIVE) -->
      <div id="protocolBox" class="box-row" style="display:none;">
        <label for="protocolInput"><strong>Αριθμός Πρωτοκόλλου:</strong></label><br />
        <input type="text" id="protocolInput" placeholder="π.χ. ΑΠ-1234/2025" />
        <div class="row-actions">
          <button class="sd-btn-small" onclick="saveProtocol()">Καταχώρηση</button>
        </div>
      </div>

      <!-- ✅ ΝΕΟ: Ακύρωση ανάθεσης (κάτω από το πρωτόκολλο, μόνο για ACTIVE) -->
      <div id="cancelBox" class="box-row" style="display:none;">
        <h4 style="margin:0 0 8px 0;">Ακύρωση Ανάθεσης Θέματος</h4>
        <label for="cancelGS"><strong>Αριθμός/Έτος ΓΣ που αποφάσισε την ακύρωση:</strong></label><br/>
        <input type="text" id="cancelGS" placeholder="π.χ. ΓΣ-15/2025" />
        <br/><br/>
        <label for="cancelReason"><strong>Λόγος ακύρωσης (ελεύθερο κείμενο):</strong></label><br/>
        <textarea id="cancelReason" placeholder="π.χ. Κατόπιν αίτησης φοιτητή/τριας"></textarea>
        <div class="row-actions">
          <button class="sd-btn-small" style="background:#c34949" onclick="cancelThesis()">Ακύρωση Θέματος</button>
        </div>
      </div>

      <!-- ✅ ΝΕΟ: Περάτωση ΔΕ (μόνο για UNDER-EXAMINATION) -->
        <div id="finishBox" class="box-row" style="display:none;">
          <h4 style="margin:0 0 8px 0;">Περάτωση Διπλωματικής</h4>
          <p id="finishPrereqs" style="margin-top:4px; color:#cfd6de;">
            Έλεγχος προϋποθέσεων…
          </p>
          <div class="row-actions">
            <button id="finishBtn" class="sd-btn-small" onclick="finalizeThesis()" disabled>Περάτωση</button>
          </div>
        </div>
  </div>

    <!-- Εισαγωγή χρηστών από JSON -->
    <section class="import-box" style="margin-top:30px;">
      <h2>Εισαγωγή Χρηστών (Φοιτητές/Διδάσκοντες)</h2>
      <input type="file" id="jsonFile" accept=".json" />
      <button class="sd-btn" onclick="uploadJSON()">Ανέβασμα</button>
    </section>
  </main>

  <script>
    function logout() {
      window.location.href = "index.html";
    }

    async function loadTheses() {
      try {
        const url = "http://localhost:3000/theses?statuses=ACTIVE,UNDER-EXAMINATION";
        const res = await fetch(url);
        if (!res.ok) throw new Error("Fetch error");
        const rows = await res.json();

        const tbody = document.getElementById("thesesBody");
        tbody.innerHTML = "";

        rows.forEach(t => {
          const tr = document.createElement("tr");
          const start = (t.StartDate || "").toString().slice(0,10);

          tr.innerHTML = `
            <td>${t.ThesisID}</td>
            <td>${escapeHtml(t.Title)}</td>
            <td>${escapeHtml(t.ProfessorName || "—")}</td>
            <td>${t.Status}</td>
            <td>${start}</td>
            <td>
              <a href="#" class="sd-btn-small" onclick="showDetails(${t.ThesisID});return false;">Προβολή</a>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        alert("⛔ Σφάλμα φόρτωσης διπλωματικών");
      }
    }

    async function showDetails(thesisId) {
      try {
        // λεπτομέρειες ΔΕ
        const res = await fetch(`http://localhost:3000/thesis/${thesisId}`);
        if (!res.ok) throw new Error("Δεν βρέθηκαν λεπτομέρειες");
        const thesis = await res.json();

        document.getElementById("detTitle").textContent = thesis.Title;
        document.getElementById("detDesc").textContent = thesis.Description;
        document.getElementById("detStatus").textContent = thesis.Status;

        // υπολογισμός χρόνου από ανάθεση
        if (thesis.StartDate) {
          const startDate = new Date(thesis.StartDate);
          const today = new Date();
          const diffMs = today - startDate;
          const diffDays = Math.floor(diffMs / (1000*60*60*24));
          document.getElementById("detElapsed").textContent = diffDays + " ημέρες";
        } else {
          document.getElementById("detElapsed").textContent = "—";
        }

        // μέλη επιτροπής
        const commRes = await fetch(`http://localhost:3000/thesis/${thesisId}/requests`);
        const committee = commRes.ok ? await commRes.json() : [];
        const list = document.getElementById("committeeList");
        list.innerHTML = "";
        if (committee.length === 0) {
          list.innerHTML = "<li>Δεν έχουν οριστεί ακόμη.</li>";
        } else {
          committee.forEach(m => {
            const li = document.createElement("li");
            li.textContent = `${m.ProfessorName} (${m.Email}) - ${m.ReqStatus}`;
            list.appendChild(li);
          });
        }

        // εμφάνιση blocks μόνο αν είναι ACTIVE
        toggleProtocolBox(thesis.Status, thesis.ThesisID, thesis.ProtocolNumber);
        toggleCancelBox(thesis.Status, thesis.ThesisID);
        toggleFinishBox(thesis.Status, thesis.ThesisID);

        document.getElementById("detailsBox").style.display = "block";
        window.scrollTo({ top: document.getElementById("detailsBox").offsetTop - 20, behavior:"smooth" });

      } catch (e) {
        console.error(e);
        alert("⛔ Σφάλμα εμφάνισης λεπτομερειών");
      }
    }

    function toggleProtocolBox(status, thesisId, currentProtocol) {
      const box = document.getElementById("protocolBox");
      if (status === "ACTIVE") {
        box.style.display = "block";
        box.setAttribute("data-thesisid", thesisId);
        document.getElementById("protocolInput").value = currentProtocol || "";
      } else {
        box.style.display = "none";
      }
    }

    function toggleCancelBox(status, thesisId) {
      const cbox = document.getElementById("cancelBox");
      if (status === "ACTIVE") {
        cbox.style.display = "block";
        cbox.setAttribute("data-thesisid", thesisId);
        document.getElementById("cancelGS").value = "";
        document.getElementById("cancelReason").value = "Κατόπιν αίτησης φοιτητή/τριας";
      } else {
        cbox.style.display = "none";
      }
    }

    async function saveProtocol() {
      const thesisId = document.getElementById("protocolBox").getAttribute("data-thesisid");
      const protocol = document.getElementById("protocolInput").value.trim();
      if (!protocol) {
        alert("⚠ Συμπλήρωσε τον αριθμό πρωτοκόλλου");
        return;
      }
      try {
        // backend σου: POST /thesis/:id/protocol
        const res = await fetch(`http://localhost:3000/thesis/${thesisId}/protocol`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ protocol })
        });
        if (!res.ok) throw new Error("Σφάλμα καταχώρησης ΑΠ");
        alert("✅ Ο ΑΠ καταχωρήθηκε!");
      } catch (e) {
        console.error(e);
        alert("⛔ " + e.message);
      }
    }

    async function cancelThesis() {
      const cbox = document.getElementById("cancelBox");
      const thesisId = cbox.getAttribute("data-thesisid");
      const gsNumber = document.getElementById("cancelGS").value.trim();
      const reason = document.getElementById("cancelReason").value.trim();

      if (!gsNumber || !reason) {
        alert("⚠ Συμπλήρωσε ΑΠ ΓΣ και λόγο ακύρωσης.");
        return;
      }

      if (!confirm("Είσαι σίγουρος/η ότι θέλεις να ακυρώσεις τη διπλωματική;")) return;

      try {
        const res = await fetch(`http://localhost:3000/thesis/${thesisId}/cancel`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gsNumber, reason })
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || "Σφάλμα ακύρωσης");
        }
        alert("✅ Η ακύρωση ολοκληρώθηκε.");
        // Ανανεώνουμε τη λίστα ώστε να φύγει από τις ACTIVE
        await loadTheses();
        document.getElementById("detailsBox").style.display = "none";
      } catch (e) {
        console.error(e);
        alert("⛔ " + e.message);
      }
    }

    function toggleFinishBox(status, thesisId){
      const fbox = document.getElementById("finishBox");
      const btn  = document.getElementById("finishBtn");
      const p    = document.getElementById("finishPrereqs");

      if(status === "UNDER-EXAMINATION"){
        fbox.style.display = "block";
        fbox.setAttribute("data-thesisid", thesisId);
        btn.disabled = true;
        p.textContent = "Έλεγχος προϋποθέσεων…";

        fetch(`http://localhost:3000/thesis/${thesisId}/finishable`)
          .then(r => r.json())
          .then(info => {
            const ok = !!info.ok;
            const g  = info.hasGrades ? "✅" : "⛔";
            const rl = info.hasRepositoryLink ? "✅" : "⛔";
            p.innerHTML = `Προϋποθέσεις: ${g} βαθμοί από επιτροπή &nbsp; • &nbsp; ${rl} σύνδεσμος Νημερτής/αποθετηρίου`;
            document.getElementById("finishBtn").disabled = !ok;
          })
          .catch(() => {
            p.textContent = "⛔ Σφάλμα ελέγχου προϋποθέσεων.";
            document.getElementById("finishBtn").disabled = true;
          });
      }else{
        fbox.style.display = "none";
      }
    }

    async function finalizeThesis(){
      const thesisId = document.getElementById("finishBox").getAttribute("data-thesisid");
      if(!confirm("Να οριστεί η διπλωματική ως Περατωμένη;")) return;

      try{
        const res = await fetch(`http://localhost:3000/thesis/${thesisId}/finalize`, { method:"POST" });
        if(!res.ok){
          const msg = await res.text();
          throw new Error(msg || "Σφάλμα περάτωσης");
        }
        alert("✅ Η διπλωματική περατώθηκε.");
        await loadTheses();
        document.getElementById("detailsBox").style.display = "none";
      }catch(e){
        console.error(e);
        alert("⛔ " + e.message);
      }
    }

    async function uploadJSON() {
      const fileInput = document.getElementById("jsonFile");
      if (!fileInput.files.length) {
        alert("⚠ Επίλεξε αρχείο JSON");
        return;
      }
      const file = fileInput.files[0];
      const text = await file.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        alert("⛔ Μη έγκυρο JSON");
        return;
      }
      try {
        const res = await fetch("http://localhost:3000/import-users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message || "ΟΚ");
      } catch (e) {
        console.error(e);
        alert("⛔ Σφάλμα στο ανέβασμα");
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, function(c) {
        return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]);
      });
    }

    loadTheses();
  </script>
</body>
</html>






