<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Λεπτομέρειες Διπλωματικής</title>
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    html, body { height: 100%; }
    body.student-details{
      background:url('images/student.png') center/cover no-repeat fixed;
    }
    body.student-details::before{
      content:""; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:0;
    }
    :root { --below-line-offset: 240px; }
    .page{
      max-width: 900px;
      margin: var(--below-line-offset) auto 40px;
      padding: 0 16px;
      position: relative; z-index: 2;
    }
    .card{
      background: rgba(0,0,0,.45);
      border-radius: 14px;
      padding: 18px;
      backdrop-filter: blur(2px);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .muted{ opacity:.85; font-size:13px; }
  </style>
  <script>
    function setBelowLineOffset(){
      const line = document.querySelector('.top-line');
      if(!line) return;
      const rect = line.getBoundingClientRect();
      const offset = Math.max(200, Math.round(rect.bottom + 32));
      document.documentElement.style.setProperty('--below-line-offset', offset + 'px');
    }
    window.addEventListener('DOMContentLoaded', setBelowLineOffset);
    window.addEventListener('resize', setBelowLineOffset);
  </script>
</head>
<body class="student-details">
  <div class="overlay-logo">
    <img src="images/logo.png" alt="logo" class="logo" />
    <div class="top-line"></div>
  </div>

  <div class="top-right-title"><h2>Λεπτομέρειες Διπλωματικής</h2></div>

  <div class="page">
    <section class="card">
      <h3 id="t_title">—</h3>
      <div class="muted" id="t_prof">—</div>
      <div class="muted" id="t_status">—</div>
      <div class="muted" id="t_dates">—</div>

      <div id="links" class="actions-row"></div>

      <div id="studentActions" class="actions-row" style="display:none;">
        <button id="btnExamination" class="btn-small">Καταχώριση Διπλωματικής</button>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    const me = JSON.parse(localStorage.getItem('user') || 'null');
    const params = new URLSearchParams(location.search);
    const queryThesisId = Number(params.get('id') || 0) || null;

    const els = {
      title:  document.getElementById('t_title'),
      prof:   document.getElementById('t_prof'),
      status: document.getElementById('t_status'),
      dates:  document.getElementById('t_dates'),
      links:  document.getElementById('links'),
      actions:document.getElementById('studentActions'),
      btnExam:document.getElementById('btnExamination')
    };

    function normalizeFileURL(s){
      if(!s) return null;
      if(/^https?:\/\//i.test(s)) return s;
      if(s.startsWith('/')) return API_BASE + s;
      return API_BASE + '/uploads/pdfs/' + s;
    }

    async function loadThesis(){
      let thesis = null;
      try{
        if(queryThesisId){
          const r = await fetch(`${API_BASE}/thesis/${queryThesisId}`);
          if(r.ok) thesis = await r.json();
        }else if(me?.Role === 'STUDENT'){
          const r = await fetch(`${API_BASE}/thesis/student/${me.UserID}`);
          const arr = await r.json();
          thesis = Array.isArray(arr) && arr[0] ? arr[0] : null;
        }
      }catch(e){}

      if(!thesis){ els.title.textContent = 'Δεν βρέθηκε διπλωματική.'; return; }

      els.title.textContent  = thesis.Title || '—';
      els.prof.textContent   = `Επιβλέπων: ${thesis.ProfessorName || '—'}`;
      els.status.textContent = `Κατάσταση: ${thesis.Status}`;
      els.dates.textContent  = `Έναρξη: ${thesis.StartDate || '—'} — Λήξη: ${thesis.EndDate || '—'}`;

      els.links.innerHTML = '';

      if(thesis.PdfPath){
        const a = document.createElement('a');
        a.href = normalizeFileURL(thesis.PdfPath);
        a.target='_blank';
        a.className='btn-small';
        a.textContent='Συνημμένο PDF θέματος';
        els.links.appendChild(a);
      }

      // ➜ Αν είμαι ο φοιτητής της ΔΕ και η κατάσταση είναι PROVISIONAL ή UNDER-ASSIGNMENT,
      //    δείξε κουμπί για τη σελίδα διαχείρισης προσκλήσεων
      const loadedFromMyList = !queryThesisId && me?.Role === 'STUDENT';
      const isOwner = Number(thesis.StudentID) === Number(me?.UserID) || loadedFromMyList;

      if (me?.Role === 'STUDENT' && isOwner) {
        if (['PROVISIONAL','UNDER-ASSIGNMENT'].includes(thesis.Status)) {
          const a = document.createElement('a');
          a.href = `under-assignment.html?thesisId=${thesis.ThesisID || queryThesisId}`;
          a.className = 'btn-small';
          a.textContent = (thesis.Status === 'PROVISIONAL') ? 'Πρόσκληση Τριμελούς' : 'Ανάθεση/Τριμελής';
          els.links.appendChild(a);
        }

        if (['ACTIVE','UNDER-EXAMINATION'].includes(thesis.Status)) {
          els.actions.style.display = 'flex';
          els.btnExam.onclick = () => {
            const id = thesis.ThesisID || queryThesisId;
            window.location.href = `examination.html?id=${id}`;
          };
        }
      } else {
        els.actions.style.display = 'none';
      }
    }

    loadThesis();
  </script>
</body>
</html>
