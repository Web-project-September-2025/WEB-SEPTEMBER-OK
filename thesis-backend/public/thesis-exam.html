<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Υπό Εξέταση - Διπλωματική</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body class="student-dashboard">

  <!-- Logo & γραμμή -->
  <div class="overlay-logo">
    <img src="images/logo.png" alt="logo" class="logo" />
    <div class="top-line"></div>
  </div>

  <div class="top-right-title">
    <h2>Υπό Εξέταση - Διπλωματική</h2>
  </div>

  <div class="thesis-details-box">
    <h3 id="thesisTitle"></h3>
    <p><strong>Περιγραφή:</strong> <span id="thesisDescription"></span></p>
    <p><strong>Φοιτητής:</strong> <span id="studentName"></span></p>
    <p><strong>Επιβλέπων:</strong> <span id="professorName"></span></p>
  </div>

  <!-- Πρόχειρο Κείμενο -->
  <div class="submissions-box">
    <h3>📄 Πρόχειρο Κείμενο</h3>
    <div id="submissionList">Δεν έχουν ανέβει αρχεία.</div>
  </div>

  <!-- Ανακοίνωση Παρουσίασης -->
  <div class="announcement-box">
    <h3>📢 Ανακοίνωση Παρουσίασης</h3>
    <button id="announcementBtn" class="btn-small">Δημιουργία Ανακοίνωσης</button>
    <p id="announcementText"></p>
  </div>

  <!-- Βαθμολογία -->
  <div class="grades-box">
    <h3>📝 Βαθμολογία</h3>
    <form id="gradeForm">
      <label for="gradeInput">Καταχώρηση βαθμού:</label>
      <input type="number" id="gradeInput" min="0" max="10" step="0.5" required />
      <button type="submit" class="btn-small">Αποθήκευση</button>
    </form>
    <div id="gradesList"></div>
  </div>

  <button class="logout-btn" onclick="window.history.back()">⬅ Επιστροφή</button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const thesisId = params.get("id");
      const user = JSON.parse(localStorage.getItem("user"));

      // Φόρτωση βασικών στοιχείων διπλωματικής
      fetch(`http://localhost:3000/thesis/${thesisId}`)
        .then(res => res.json())
        .then(thesis => {
          document.getElementById("thesisTitle").textContent = thesis.Title;
          document.getElementById("thesisDescription").textContent = thesis.Description;
          document.getElementById("studentName").textContent = thesis.StudentName || "—";
          document.getElementById("professorName").textContent = thesis.ProfessorName || "—";
        });

      // Φόρτωση submissions
      fetch(`http://localhost:3000/submissions/${thesisId}`)
        .then(res => res.json())
        .then(subs => {
          const container = document.getElementById("submissionList");
          container.innerHTML = "";
          if (subs.length === 0) {
            container.textContent = "Δεν έχουν ανέβει αρχεία.";
            return;
          }
          subs.forEach(s => {
            const div = document.createElement("div");
            div.innerHTML = `<a href="${s.FileURL}" target="_blank">Λήψη Αρχείου</a>`;
            container.appendChild(div);
          });
        });

      // Κουμπί ανακοίνωσης
      document.getElementById("announcementBtn").addEventListener("click", () => {
        fetch(`http://localhost:3000/announcement/${thesisId}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("announcementText").textContent = data.message;
          })
          .catch(err => alert("Σφάλμα στην ανακοίνωση"));
      });

      // Φόρτωση βαθμών
      function loadGrades() {
        fetch(`http://localhost:3000/grade/${thesisId}`)
          .then(res => res.json())
          .then(grades => {
            const list = document.getElementById("gradesList");
            list.innerHTML = "";
            grades.forEach(g => {
              const div = document.createElement("div");
              div.textContent = `${g.Professor}: ${g.Grade}`;
              list.appendChild(div);
            });
          });
      }
      loadGrades();

      // Καταχώρηση βαθμού
      document.getElementById("gradeForm").addEventListener("submit", e => {
        e.preventDefault();
        const grade = document.getElementById("gradeInput").value;

        fetch(`http://localhost:3000/grade`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ExamID: thesisId, // προσοχή εδώ αν θες ExamID ή ThesisID
            ProfessorID: user.UserID,
            Grade: grade
          })
        })
        .then(res => res.json())
        .then(data => {
          alert("✅ Βαθμός αποθηκεύτηκε");
          loadGrades();
        })
        .catch(err => alert("Σφάλμα αποθήκευσης βαθμού"));
      });
    });
  </script>
</body>
</html>
