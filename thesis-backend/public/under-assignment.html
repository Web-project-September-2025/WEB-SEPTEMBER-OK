<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Υπό Ανάθεση Διπλωματική</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body class="student-dashboard">
  <!-- Logo & γραμμή -->
  <div class="overlay-logo">
    <img src="images/logo.png" alt="logo" class="logo" />
    <div class="top-line"></div>
  </div>

  <!-- Τίτλος -->
  <div class="top-right-title">
    <h2>Διπλωματική: Υπό Ανάθεση</h2>
  </div>

  <div class="thesis-details-section">
    <h3 id="thesisTitle">Τίτλος</h3>
    <p id="thesisDescription">Περιγραφή</p>

    <label for="professorSelect">Προσθήκη μέλους επιτροπής:</label>
    <select id="professorSelect"></select>
    <button id="inviteBtn" class="btn-small">Πρόσκληση</button>

    <h4>Αιτήσεις προς καθηγητές:</h4>
    <ul id="requestsList"></ul>
  </div>

  <button class="logout-btn" onclick="window.location.href='student-dashboard.html'">Επιστροφή</button>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    let thesisId = null;

    document.addEventListener("DOMContentLoaded", () => {
      // Πάρε τη διπλωματική του φοιτητή
      fetch(`http://localhost:3000/thesis/student/${user.UserID}`)
        .then(res => res.json())
        .then(data => {
          const thesis = data.find(t => t.Status === "UNDER-ASSIGNMENT");
          if (!thesis) {
            alert("Δεν βρέθηκε διπλωματική σε κατάσταση 'Υπό Ανάθεση'");
            return;
          }
          thesisId = thesis.ThesisID;

          document.getElementById("thesisTitle").textContent = thesis.Title;
          document.getElementById("thesisDescription").textContent = thesis.Description;

          loadProfessors();
          loadRequests();
        });

      // Πρόσκληση καθηγητή
      document.getElementById("inviteBtn").addEventListener("click", () => {
        const professorId = document.getElementById("professorSelect").value;
        if (!professorId) return alert("Επιλέξτε καθηγητή!");

        fetch("http://localhost:3000/requests", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ThesisID: thesisId, ProfessorID: professorId })
        })
        .then(res => {
          if (!res.ok) throw new Error("Αποτυχία αποστολής αίτησης");
          return res.json();
        })
        .then(() => {
          alert("Η αίτηση εστάλη");
          loadRequests();
        })
        .catch(err => alert("Σφάλμα: " + err.message));
      });
    });

    // Φόρτωσε καθηγητές
    function loadProfessors() {
      fetch("http://localhost:3000/professors")
        .then(res => res.json())
        .then(professors => {
          const select = document.getElementById("professorSelect");
          select.innerHTML = `<option value="">-- Επιλογή Καθηγητή --</option>`;
          professors.forEach(p => {
            const option = document.createElement("option");
            option.value = p.UserID;
            option.textContent = `${p.UserName} (${p.Email})`;
            select.appendChild(option);
          });
        });
    }

    // Φόρτωσε αιτήσεις
    function loadRequests() {
      if (!thesisId) return;
      fetch(`http://localhost:3000/requests/${thesisId}`)
        .then(res => res.json())
        .then(requests => {
          const list = document.getElementById("requestsList");
          list.innerHTML = "";
          requests.forEach(r => {
            const li = document.createElement("li");
            li.textContent = `${r.UserName} - ${r.ReqStatus}`;
            list.appendChild(li);
          });
        });
    }
  </script>
</body>
</html>