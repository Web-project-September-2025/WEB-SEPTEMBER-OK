<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Υπό Ανάθεση Διπλωματική</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body class="student-dashboard">
  <!-- Logo & γραμμή -->
  <div class="overlay-logo">
    <img src="images/logo.png" alt="logo" class="logo" />
    <div class="top-line"></div>
  </div>

  <!-- Τίτλος -->
  <div class="top-right-title">
    <h2>Διπλωματική: Υπό Ανάθεση</h2>
  </div>

  <div class="thesis-details-section">
    <h3 id="thesisTitle">Τίτλος</h3>
    <p id="thesisDescription">Περιγραφή</p>

    <label for="professorSelect">Προσθήκη μέλους επιτροπής:</label>
    <select id="professorSelect"></select>
    <button id="inviteBtn" class="btn-small">Πρόσκληση</button>

    <h4>Αιτήσεις προς καθηγητές:</h4>
    <ul id="requestsList"></ul>
  </div>

  <button class="logout-btn" onclick="window.location.href='student-dashboard.html'">Επιστροφή</button>

  <script>
  const user = JSON.parse(localStorage.getItem("user"));
  let thesis = null;

  document.addEventListener("DOMContentLoaded", () => {
    if (!user || user.Role !== "STUDENT") {
      alert("⛔ Μη εξουσιοδοτημένη πρόσβαση");
      window.location.href = "login.html";
      return;
    }

    // Φέρε τη ΔΕ που είναι UNDER-ASSIGNMENT
    fetch(`http://localhost:3000/thesis/student/${user.UserID}`)
      .then(res => res.json())
      .then(theses => {
        thesis = theses.find(t => t.Status === "UNDER-ASSIGNMENT");
        if (!thesis) {
          alert("Δεν βρέθηκε διπλωματική σε κατάσταση 'Υπό Ανάθεση'");
          return;
        }

        document.getElementById("thesisTitle").textContent = thesis.Title;
        document.getElementById("thesisDescription").textContent = thesis.Description;

        loadProfessors();
        loadRequests();
      })
      .catch(err => {
        console.error(err);
        alert("Σφάλμα φόρτωσης.");
      });
  });

  // Φέρε όλους τους διαθέσιμους καθηγητές για επιλογή
  async function loadProfessors(thesis) {
  try {
    const res = await fetch(`${API_BASE}/users?role=PROFESSOR`);
    if (!res.ok) throw new Error("Σφάλμα στο fetch");
    const professors = await res.json();

    const select = document.getElementById("professorSelect");
    select.innerHTML = "";

    professors
      .filter(p => p.UserID !== thesis.ProfessorID) 
      .forEach(prof => {
        const opt = document.createElement("option");
        opt.value = prof.UserID;
        opt.textContent = prof.UserName;
        select.appendChild(opt);
      });
  } catch (err) {
    console.error("Σφάλμα φόρτωσης καθηγητών", err);
  }
}

  // Πρόσκληση νέου μέλους
  document.getElementById("inviteBtn").addEventListener("click", () => {
    const profId = document.getElementById("professorSelect").value;
    if (!profId) return;

    fetch(`http://localhost:3000/thesis/${thesis.ThesisID}/invite`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ professorId: profId })
    })
    .then(res => res.json())
    .then(data => {
      alert("✅ Στάλθηκε πρόσκληση!");
      loadRequests();
    })
    .catch(err => {
      console.error(err);
      alert("⛔ Σφάλμα αποστολής πρόσκλησης");
    });
  });

  // Φέρε τις τρέχουσες αιτήσεις
  function loadRequests() {
    fetch(`http://localhost:3000/thesis/${thesis.ThesisID}/requests`)
      .then(res => res.json())
      .then(requests => {
        const ul = document.getElementById("requestsList");
        ul.innerHTML = "";
        requests.forEach(r => {
          const li = document.createElement("li");
          li.textContent = `${r.ProfessorName} - ${r.Status}`;
          ul.appendChild(li);
        });
      });
  }
  </script>
</body>
</html>

