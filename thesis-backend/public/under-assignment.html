<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Υπό Ανάθεση / Προσκλήσεις Τριμελούς</title>
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .note { margin: 10px 0; padding: 10px; border-radius: 8px; background: rgba(255,255,255,.1); }
    .muted { opacity:.9; font-size:14px; }
  </style>
</head>
<body class="student-dashboard">
  <div class="overlay-logo">
    <img src="images/logo.png" alt="logo" class="logo" />
    <div class="top-line"></div>
  </div>

  <div class="top-right-title">
    <h2>Διπλωματική: Υπό Ανάθεση / Προσκλήσεις</h2>
  </div>

  <div class="thesis-details-section">
    <h3 id="thesisTitle">Τίτλος</h3>
    <p id="thesisDescription" class="muted">Περιγραφή</p>
    <p id="statusLine" class="muted">Κατάσταση: —</p>

    <div id="inviteArea">
      <label for="professorSelect">Προσθήκη μέλους επιτροπής:</label>
      <select id="professorSelect"></select>
      <button id="inviteBtn" class="btn-small">Πρόσκληση</button>
      <div id="inviteNote" class="note" style="display:none;"></div>
    </div>

    <h4>Αιτήσεις προς καθηγητές:</h4>
    <ul id="requestsList"></ul>
  </div>

  <button class="logout-btn" onclick="window.location.href='student-dashboard.html'">Επιστροφή</button>

  <script>
    const API_BASE = "http://localhost:3000";
    const user = JSON.parse(localStorage.getItem("user") || "null");
    const token = localStorage.getItem("authToken") || "";
    const authHeader = token ? { "Authorization": "Bearer " + token } : {};
    const params = new URLSearchParams(location.search);

    let thesisId = Number(params.get("thesisId") || params.get("id") || 0) || null;
    let thesis = null;

    const els = {
      title: document.getElementById("thesisTitle"),
      desc:  document.getElementById("thesisDescription"),
      status:document.getElementById("statusLine"),
      inviteArea: document.getElementById("inviteArea"),
      professorSelect: document.getElementById("professorSelect"),
      inviteBtn: document.getElementById("inviteBtn"),
      inviteNote: document.getElementById("inviteNote"),
      requestsList: document.getElementById("requestsList")
    };

    document.addEventListener("DOMContentLoaded", init);

    async function init(){
      if (!user || user.Role !== "STUDENT") {
        alert("Μόνο για φοιτητές.");
        window.location.href = "login.html"; return;
      }

      thesis = await resolveThesis();
      if (!thesis) { alert("Δεν βρέθηκε διπλωματική."); return; }
      thesisId = thesis.ThesisID;

      fillHeader(thesis);
      configureInviteUI(thesis);

      await loadRequests();
      if (thesis.Status === "PROVISIONAL") {
        await loadProfessors();
      }
    }

    // βρες ΔΕ: 1) από query, 2) από τις δικές μου (PROVISIONAL ή UNDER-ASSIGNMENT)
    async function resolveThesis(){
      try{
        if (thesisId) {
          const r = await fetch(`${API_BASE}/thesis/${thesisId}`);
          if (r.ok) return await r.json();
        } else {
          const r = await fetch(`${API_BASE}/thesis/student/${user.UserID}`);
          const list = await r.json();
          return list.find(t => t.Status === "PROVISIONAL")
              || list.find(t => t.Status === "UNDER-ASSIGNMENT")
              || null;
        }
      }catch{}
      return null;
    }

    function fillHeader(t){
      els.title.textContent = t.Title || "—";
      els.desc.textContent  = t.Description || "—";
      els.status.textContent= `Κατάσταση: ${t.Status}`;
    }

    function configureInviteUI(t){
      if (t.Status === "PROVISIONAL") {
        // επιτρέπεται πρόσκληση
        els.inviteArea.style.display = "block";
        els.inviteNote.style.display = "none";
        els.inviteBtn.disabled = false;

        els.inviteBtn.onclick = onInvite;
      } else {
        // δεν επιτρέπεται ακόμα
        els.inviteArea.style.display = "block";
        els.inviteBtn.disabled = true;
        els.professorSelect.disabled = true;
        els.inviteNote.style.display = "block";
        els.inviteNote.textContent =
          "Οι προσκλήσεις προς μέλη τριμελούς ενεργοποιούνται μόλις η διπλωματική γίνει PROVISIONAL (προσωρινή ανάθεση).";
      }
    }

    async function onInvite(){
      const professorId = Number(els.professorSelect.value || 0);
      if (!professorId) return alert("Επιλέξτε καθηγητή!");

      try{
        const res = await fetch(`${API_BASE}/student/thesis/${thesisId}/invite`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeader },
          body: JSON.stringify({ professorId })
        });
        const j = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(j.message || "Αποτυχία αποστολής αίτησης");

        alert(j.message || "Η πρόσκληση εστάλη");
        await loadProfessors();
        await loadRequests();
      }catch(err){
        alert("Σφάλμα: " + err.message);
      }
    }

    // Φόρτωση καθηγητών (εξαιρεί ήδη προσκεκλημένους/accepted & τον εαυτό μου)
    async function loadProfessors(){
      try{
        const r = await fetch(`${API_BASE}/professors?excludeThesisId=${thesisId}&excludeMe=1`, { headers: { ...authHeader } });
        const profs = await r.json();

        els.professorSelect.innerHTML = `<option value="">-- Επιλογή Καθηγητή --</option>`;
        (profs || []).forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.UserID;
          opt.textContent = `${p.UserName} (${p.Email})`;
          els.professorSelect.appendChild(opt);
        });
      }catch{}
    }

    // Φόρτωση αιτήσεων (student endpoint με timestamps)
    async function loadRequests(){
      try{
        const r = await fetch(`${API_BASE}/student/thesis/${thesisId}/requests`, { headers: { ...authHeader } });
        const requests = await r.json();
        els.requestsList.innerHTML = "";
        if (!Array.isArray(requests) || !requests.length) {
          els.requestsList.innerHTML = "<li>—</li>";
          return;
        }
        requests.forEach(r => {
          const li = document.createElement("li");
          const when = r.AcceptedAt || r.RejectedAt || r.CreatedAt || "";
          li.textContent = `${r.ProfessorName} — ${r.ReqStatus}${when ? " ("+when+")" : ""}`;
          els.requestsList.appendChild(li);
        });
      }catch{
        els.requestsList.innerHTML = "<li>—</li>";
      }
    }
  </script>
</body>
</html>
